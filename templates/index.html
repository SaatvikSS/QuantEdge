<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum-AI Tokenization Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .token-table {
            font-size: 0.9em;
            max-height: 400px;
            overflow-y: auto;
        }
        .stats-card {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .refresh-btn {
            position: absolute;
            right: 20px;
            top: 20px;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container py-5">
        <!-- Login Form -->
        <div id="loginForm" class="card p-4 mb-4">
            <h3 class="mb-4">Login</h3>
            <form onsubmit="login(event)">
                <div class="mb-3">
                    <label for="username" class="form-label">Username</label>
                    <input type="text" class="form-control" id="username" required>
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" class="form-control" id="password" required>
                </div>
                <button type="submit" class="btn btn-primary">Login</button>
            </form>
        </div>

        <!-- Main Dashboard -->
        <div id="dashboard" style="display: none;">
            <h2 class="mb-4">Quantum-AI Tokenization Dashboard</h2>
            <button onclick="refreshData()" class="btn btn-outline-primary refresh-btn">
                <i class="bi bi-arrow-clockwise"></i> Refresh Data
            </button>

            <!-- Statistics -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="stats-card">
                        <h5>Total Files Processed</h5>
                        <h2 id="totalFiles">0</h2>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stats-card">
                        <h5>Total Records Processed</h5>
                        <h2 id="totalRecords">0</h2>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stats-card">
                        <h5>Total Tokens Generated</h5>
                        <h2 id="totalTokens">0</h2>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Recent Activity</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>File Name</th>
                                    <th>Source → Target</th>
                                    <th>Fields Tokenized</th>
                                    <th>Records</th>
                                </tr>
                            </thead>
                            <tbody id="recentActivity">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Token Mappings -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Token Mappings</h5>
                </div>
                <div class="card-body">
                    <div class="token-table">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Field</th>
                                    <th>Original Value</th>
                                    <th>Token</th>
                                </tr>
                            </thead>
                            <tbody id="tokenMappings">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let accessToken = null;

        async function login(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch('/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`
                });

                if (!response.ok) {
                    throw new Error('Login failed');
                }

                const data = await response.json();
                accessToken = data.access_token;
                
                // Show dashboard and hide login form
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                
                // Load initial data
                refreshData();
                
            } catch (error) {
                alert('Login failed. Please check your credentials.');
            }
        }

        async function refreshData() {
            if (!accessToken) return;

            try {
                // Fetch statistics
                const statsResponse = await fetch('/api/stats', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                const stats = await statsResponse.json();

                // Update statistics
                document.getElementById('totalFiles').textContent = stats.files_processed.length;
                document.getElementById('totalRecords').textContent = stats.total_records;
                document.getElementById('totalTokens').textContent = stats.total_tokens;

                // Update recent activity
                const recentActivity = document.getElementById('recentActivity');
                recentActivity.innerHTML = stats.files_processed
                    .slice(-5)
                    .reverse()
                    .map(file => `
                        <tr>
                            <td>${new Date(file.timestamp).toLocaleString()}</td>
                            <td>${file.file_name}</td>
                            <td>${file.source_department} → ${file.target_department}</td>
                            <td>${file.fields_tokenized.join(', ')}</td>
                            <td>${file.records_processed}</td>
                        </tr>
                    `)
                    .join('');

                // Fetch token mappings
                const mappingsResponse = await fetch('/api/token-mappings', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                const mappings = await mappingsResponse.json();

                // Update token mappings
                const tokenMappings = document.getElementById('tokenMappings');
                tokenMappings.innerHTML = Object.entries(mappings)
                    .flatMap(([field, values]) =>
                        Object.entries(values)
                            .map(([original, token]) => `
                                <tr>
                                    <td>${field}</td>
                                    <td>${original}</td>
                                    <td>${token}</td>
                                </tr>
                            `)
                    )
                    .join('');

            } catch (error) {
                console.error('Error refreshing data:', error);
                alert('Failed to refresh data. Please try again.');
            }
        }

        // Auto-refresh every 30 seconds
        setInterval(refreshData, 30000);
    </script>
</body>
</html>
